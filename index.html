<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Jazz Theory - Ultimate</title>
    <style>
        body { background-color: #1a1a1a; color: #eee; font-family: "Helvetica Neue", Arial, sans-serif; text-align: center; padding: 20px; user-select: none; }
        h1 { margin: 0 0 20px 0; font-size: 24px; color: #ddd; letter-spacing: 2px; }

        /* „É¨„Ç§„Ç¢„Ç¶„ÉàÊû† */
        .main-container {
            max-width: 1100px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Âá°‰æã */
        .legend {
            display: inline-flex; justify-content: center; gap: 20px; padding: 10px 20px;
            background: #333; border-radius: 50px; margin-bottom: 10px; border: 1px solid #555;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }

        /* „Ç≥„Éº„ÉâË°®Á§∫ */
        .chord-display {
            font-size: 56px; font-weight: 800; height: 70px; margin: 10px 0;
            color: #ffd700; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            font-family: "Courier New", monospace;
        }

        /* ÊåáÊùø */
        .fretboard {
            position: relative; width: 100%; height: 220px;
            background-color: #4a3c31; border: 6px solid #2a2a2a; border-radius: 4px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin-bottom: 20px;
            overflow: hidden; /* „ÅØ„ÅøÂá∫„ÅóÈò≤Ê≠¢ */
        }
        .string { position: absolute; left: 0; right: 0; height: 2px; background-color: #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .fret-line { position: absolute; top: 0; bottom: 0; width: 4px; background-color: #888; border-right: 2px solid #555; }
        .fret-number { position: absolute; bottom: 5px; width: 100%; text-align: center; font-size: 12px; color: #bbb; font-weight: bold; opacity: 0.7; }
        .note-marker {
            position: absolute; width: 30px; height: 30px; border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.8); z-index: 10;
            transition: all 0.2s ease-out;
        }

        /* Ëâ≤ÂÆöÁæ© */
        .color-blue { background: radial-gradient(circle, #00aaff 0%, #0077cc 100%); box-shadow: 0 0 15px #00aaff; border: 2px solid white; }
        .color-green { background: radial-gradient(circle, #00ff88 0%, #00cc66 100%); box-shadow: 0 0 15px #00ff88; }
        .color-red { background: radial-gradient(circle, #ff4444 0%, #cc0000 100%); box-shadow: 0 0 20px #ff2222; z-index: 20; }

        /* „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´Áæ§ */
        .panel { background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #444; text-align: left; }
        .panel-title { font-size: 14px; color: #00ff88; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; display: flex; justify-content: space-between; }

        /* „Éú„Çø„É≥ÂÖ±ÈÄö */
        button {
            padding: 8px 16px; font-size: 14px; cursor: pointer; border-radius: 4px; border: none; color: white; transition: 0.2s; font-weight: bold;
        }
        button:hover { opacity: 0.8; }
        button:active { transform: translateY(2px); }
        
        .btn-primary { background: #0088cc; }
        .btn-danger { background: #cc3333; }
        .btn-success { background: #00aa66; }
        .btn-dark { background: #444; }
        
        select, input[type=text] { padding: 8px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; }

        /* 1. ‰øùÂ≠ò„ÉªË™≠Ëæº„Ç®„É™„Ç¢ */
        .storage-area { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .save-group { display: flex; gap: 5px; flex: 1; }
        
        /* 2. „Éì„É´„ÉÄ„Éº„Ç®„É™„Ç¢ */
        .builder-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        .chord-list {
            display: flex; flex-wrap: wrap; gap: 8px; min-height: 50px; padding: 10px;
            background: #111; border: 1px inset #333; border-radius: 4px;
        }
        .chord-card {
            background: #3a3a3a; padding: 5px 10px; border-radius: 4px; font-size: 14px;
            display: flex; align-items: center; gap: 8px; border: 1px solid #555; animation: popIn 0.3s;
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        .delete-btn { background: #ff5555; width: 18px; height: 18px; font-size: 10px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* 3. „Éó„É¨„Ç§ÔºÜÈå≤Èü≥„Ç®„É™„Ç¢ */
        .play-controls { display: flex; align-items: center; gap: 20px; justify-content: space-between; }
        .main-play-btn { flex: 1; padding: 15px; font-size: 20px; background: linear-gradient(to bottom, #444, #222); border: 1px solid #666; }
        .main-play-btn.active { background: linear-gradient(to bottom, #cc3333, #990000); border-color: #ff5555; }
        
        .rec-box { display: flex; align-items: center; gap: 10px; background: #000; padding: 5px 15px; border-radius: 30px; border: 1px solid #333; }
        .rec-dot { width: 12px; height: 12px; background: #555; border-radius: 50%; }
        .rec-dot.recording { background: #ff0000; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* „Çπ„É©„Ç§„ÉÄ„ÉºÁ≠â */
        .settings-row { display: flex; align-items: center; gap: 20px; margin-top: 10px; color: #aaa; font-size: 14px; }
        input[type=range] { flex: 1; cursor: pointer; }
        
    </style>
</head>
<body>

    <div class="main-container">
        
        <div>
            <h1>Visual Jazz Theory <span style="font-size:14px; color:#00aa66; vertical-align:middle; border:1px solid #00aa66; padding:2px 6px; border-radius:4px;">ULTIMATE</span></h1>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot color-blue"></div> Code Tone</div>
                <div class="legend-item"><div class="legend-dot color-green"></div> Tension</div>
                <div class="legend-item"><div class="legend-dot color-red"></div> Avoid</div>
            </div>
            <div id="currentChord" class="chord-display">Let's Jazz.</div>
        </div>

        <div id="fretboard" class="fretboard"></div>

        <div class="panel">
            <div class="panel-title">
                <span>üéÆ CONTROL & REC</span>
                <div class="rec-box">
                    <div id="recDot" class="rec-dot"></div>
                    <span id="recStatus">Ready</span>
                </div>
            </div>
            <div class="play-controls">
                <button id="playBtn" class="main-play-btn" onclick="togglePlay()">‚ñ∂ START SESSION</button>
                <button id="recBtn" class="btn-danger" onclick="toggleRecord()">‚óè REC</button>
                <a id="downloadLink" style="display:none" class="btn-success" style="padding:8px 16px; text-decoration:none; border-radius:4px;">‚¨á DL</a>
            </div>
            <div class="settings-row">
                <label id="bpmDisplay">BPM: 120</label>
                <input type="range" id="bpmSlider" min="40" max="300" value="120" oninput="updateBpm(this.value)">
                <label><input type="checkbox" id="clickToggle" checked> Click</label>
                <label><input type="radio" name="disp" value="note" checked onclick="redraw()"> Èü≥Âêç</label>
                <label><input type="radio" name="disp" value="degree" onclick="redraw()"> Â∫¶Êï∞</label>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">üìö LIBRARY (Local Storage)</div>
            <div class="storage-area">
                <select id="presetSelect" onchange="loadPreset(this.value)">
                    <option value="">-- „Éó„É™„Çª„ÉÉ„ÉàÊõ≤ --</option>
                    <option value="autumn">üçÇ ÊûØËëâ (Gm)</option>
                    <option value="flyme">üåï Fly Me To The Moon (C)</option>
                    <option value="f_blues">üé∑ F Blues</option>
                    <option value="two_five">üîÑ 2-5-1-6 Loop</option>
                </select>
                <span style="color:#555">|</span>
                <select id="userSongSelect">
                    <option value="">-- „É¶„Éº„Ç∂„Éº‰øùÂ≠òÊõ≤ --</option>
                </select>
                <button class="btn-primary" onclick="loadUserSong()">Ë™≠Ëæº</button>
                <button class="btn-danger" onclick="deleteUserSong()">ÂâäÈô§</button>
                <span style="flex:1"></span>
                <div class="save-group">
                    <input type="text" id="saveName" placeholder="Êõ≤Âêç„ÇíÂÖ•Âäõ...">
                    <button class="btn-success" onclick="saveCurrentSong()">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">üõ†Ô∏è CHORD EDITOR</div>
            <div class="builder-controls">
                <select id="rootSelect">
                    <option value="0">C</option><option value="1">Db</option><option value="2">D</option>
                    <option value="3">Eb</option><option value="4">E</option><option value="5">F</option>
                    <option value="6">Gb</option><option value="7">G</option><option value="8">Ab</option>
                    <option value="9">A</option><option value="10">Bb</option><option value="11">B</option>
                </select>
                <select id="typeSelect">
                    <option value="maj7">maj7</option><option value="m7">m7</option><option value="7">7</option>
                    <option value="m7b5">m7b5</option><option value="dim">dim</option>
                </select>
                <button class="btn-primary" onclick="addChordBtn()">Ôºã ËøΩÂä†</button>
                <button class="btn-dark" onclick="clearAll()">ÂÖ®Ê∂àÂéª</button>
            </div>
            <div id="chordList" class="chord-list">
                <div style="color:#666; font-size:12px;">„Åì„Åì„Å´„Ç≥„Éº„Éâ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. Èü≥Ê•ΩÁêÜË´ñ„Éá„Éº„Çø ---
        const openStrings = [64, 59, 55, 50, 45, 40]; 
        const noteNames = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
        const degreeNames = ["R", "b9", "9", "b3", "3", "11", "#11", "5", "b13", "13", "b7", "7"];

        const chordRules = {
            "maj7": { rules: {0:"blue",4:"blue",7:"blue",11:"blue",2:"green",9:"green",5:"red"}, voicing: [0,4,7,11] },
            "m7":   { rules: {0:"blue",3:"blue",7:"blue",10:"blue",2:"green",5:"green",9:"green"}, voicing: [0,3,7,10] },
            "7":    { rules: {0:"blue",4:"blue",7:"blue",10:"blue",2:"green",9:"green",5:"red"}, voicing: [0,4,7,10] },
            "m7b5": { rules: {0:"blue",3:"blue",6:"blue",10:"blue",5:"green",8:"green",2:"red"}, voicing: [0,3,6,10] },
            "dim":  { rules: {0:"blue",3:"blue",6:"blue",9:"blue",2:"green",5:"green",8:"green",11:"green"}, voicing: [0,3,6,9] }
        };

        // „Éó„É™„Çª„ÉÉ„Éà„Éá„Éº„Çø
        const presets = {
            "autumn": [{r:0,t:"m7"},{r:5,t:"7"},{r:10,t:"maj7"},{r:3,t:"maj7"},{r:9,t:"m7b5"},{r:2,t:"7"},{r:7,t:"m7"},{r:7,t:"m7"}],
            "flyme": [{r:9,t:"m7"},{r:2,t:"m7"},{r:7,t:"7"},{r:0,t:"maj7"},{r:5,t:"maj7"},{r:11,t:"m7b5"},{r:4,t:"7"},{r:9,t:"m7"}],
            "f_blues": [{r:5,t:"7"},{r:10,t:"7"},{r:5,t:"7"},{r:5,t:"7"},{r:10,t:"7"},{r:10,t:"7"},{r:5,t:"7"},{r:2,t:"7"},{r:7,t:"m7"},{r:0,t:"7"},{r:5,t:"7"},{r:0,t:"7"}],
            "two_five": [{r:2,t:"m7"},{r:7,t:"7"},{r:0,t:"maj7"},{r:9,t:"7"}]
        };

        let playList = [];

        // --- 2. „É≠„Ç∏„ÉÉ„ÇØ („Éì„É´„Éâ/‰øùÂ≠ò) ---
        
        function addChord(r, t) {
            const rootName = noteNames[r];
            const displayName = rootName + t;
            const ruleData = chordRules[t];
            playList.push({
                displayName: displayName, rootNote: r, type: t,
                rules: ruleData.rules, voicing: ruleData.voicing
            });
            renderList();
        }
        
        function addChordBtn() {
            const r = parseInt(document.getElementById('rootSelect').value);
            const t = document.getElementById('typeSelect').value;
            addChord(r, t);
        }
        
        function removeChord(idx) {
            playList.splice(idx, 1);
            renderList();
        }
        
        function clearAll() { playList = []; renderList(); }

        function renderList() {
            const el = document.getElementById('chordList');
            el.innerHTML = '';
            if(playList.length===0) { el.innerHTML = '<div style="color:#666; font-size:12px;">„Åì„Åì„Å´„Ç≥„Éº„Éâ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>'; return; }
            playList.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'chord-card';
                div.innerHTML = `<span>${c.displayName}</span><button class="delete-btn" onclick="removeChord(${i})">√ó</button>`;
                el.appendChild(div);
            });
        }

        // ‰øùÂ≠òÊ©üËÉΩ (LocalStorage)
        function updateStorageList() {
            const sel = document.getElementById('userSongSelect');
            sel.innerHTML = '<option value="">-- „É¶„Éº„Ç∂„Éº‰øùÂ≠òÊõ≤ --</option>';
            const keys = Object.keys(localStorage);
            keys.forEach(k => {
                if(k.startsWith('vjt_song_')) {
                    const name = k.replace('vjt_song_', '');
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.innerText = name;
                    sel.appendChild(opt);
                }
            });
        }
        
        function saveCurrentSong() {
            const name = document.getElementById('saveName').value;
            if(!name || playList.length===0) { alert("Êõ≤Âêç„ÇíÂÖ•Âäõ„Åó„ÄÅ„Ç≥„Éº„Éâ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
            // Á∞°ÊòìÂåñ„ÅÆ„Åü„ÇÅ„Éó„É¨„Ç§„É™„Çπ„Éà„ÅÆÊßãÊàê„Éá„Éº„Çø„ÅÆ„Åø‰øùÂ≠ò
            const saveData = playList.map(c => ({ r: c.rootNote, t: c.type }));
            localStorage.setItem('vjt_song_' + name, JSON.stringify(saveData));
            alert(`„Äé${name}„Äè„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ`);
            updateStorageList();
        }
        
        function loadUserSong() {
            const name = document.getElementById('userSongSelect').value;
            if(!name) return;
            const json = localStorage.getItem('vjt_song_' + name);
            if(json) {
                const data = JSON.parse(json);
                playList = [];
                data.forEach(c => addChord(c.r, c.t));
                alert(`„Äé${name}„Äè„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
            }
        }

        function deleteUserSong() {
            const name = document.getElementById('userSongSelect').value;
            if(!name) return;
            if(confirm(`Êú¨ÂΩì„Å´„Äé${name}„Äè„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                localStorage.removeItem('vjt_song_' + name);
                updateStorageList();
            }
        }

        function loadPreset(key) {
            if(!key) return;
            const data = presets[key];
            playList = [];
            data.forEach(c => addChord(c.r, c.t));
            // alert‰∏çË¶Å„Åß„Çµ„ÇØ„ÉÉ„Å®Ë™≠„ÅøËæº„ÇÄ
        }

        // --- 3. „Ç®„É≥„Ç∏„É≥ (ÂÜçÁîü/ÊèèÁîª/Èå≤Èü≥) ---
        
        let isPlaying = false;
        let currentIndex = 0;
        let beatIndex = 0;
        let timerId = null;
        let audioCtx = null;

        // Èå≤Èü≥Áî®Â§âÊï∞
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

        // „Éû„Ç§„ÇØÈå≤Èü≥„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        async function setupRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const link = document.getElementById('downloadLink');
                    link.href = audioUrl;
                    link.download = 'my_practice_session.webm';
                    link.style.display = 'inline-block';
                    link.innerText = "‚¨á „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ";
                    audioChunks = [];
                };
            } catch(err) {
                console.error("Mic Error:", err);
                alert("„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åü„Åã„ÄÅÈùûÂØæÂøú„Åß„Åô„ÄÇ(VercelÁ≠â„ÅßHTTPSÊé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ)");
            }
        }

        function toggleRecord() {
            const btn = document.getElementById('recBtn');
            const dot = document.getElementById('recDot');
            const status = document.getElementById('recStatus');

            if(!isRecording) {
                // Èå≤Èü≥ÈñãÂßã
                if(!mediaRecorder) { setupRecording().then(() => startRecLogic()); } 
                else { startRecLogic(); }
            } else {
                // Èå≤Èü≥ÂÅúÊ≠¢
                mediaRecorder.stop();
                isRecording = false;
                btn.innerText = "‚óè REC";
                dot.classList.remove('recording');
                status.innerText = "Recorded";
            }

            function startRecLogic() {
                if(!mediaRecorder) return;
                audioChunks = [];
                mediaRecorder.start();
                isRecording = true;
                btn.innerText = "‚ñ† STOP REC";
                dot.classList.add('recording');
                status.innerText = "Recording...";
                // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„É™„É≥„ÇØ„ÇíÈö†„Åô
                document.getElementById('downloadLink').style.display = 'none';
            }
        }

        function playClick(isAccent) {
            if (!document.getElementById('clickToggle').checked) return;
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = isAccent ? 1200 : 800;
            gain.gain.setValueAtTime(isAccent?0.2:0.05, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t+0.05);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(t); osc.stop(t+0.05);
        }

        function playTone(noteNum, dur) {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.value = 440 * Math.pow(2, (noteNum-69)/12);
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.1, t+0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, t+dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(t); osc.stop(t+dur);
        }

        function drawFretboard() {
            const board = document.getElementById('fretboard');
            const disp = document.getElementById('currentChord');
            
            if(playList.length===0) { board.innerHTML=''; disp.innerText="No Chord"; return; }
            
            const c = playList[currentIndex];
            board.innerHTML = '';
            disp.innerText = c.displayName;
            
            const mode = document.querySelector('input[name="disp"]:checked').value;

            // Âº¶„Å®„Éï„É¨„ÉÉ„Éà
            for(let s=0; s<6; s++){
                let st=document.createElement('div'); st.className='string'; st.style.top=(s*35+25)+'px'; board.appendChild(st);
            }
            for(let f=0; f<=12; f++){
                let fr=document.createElement('div'); fr.className='fret-line'; fr.style.left=(f*7.6)+'%'; 
                if(f>0) {
                    let nm=document.createElement('div'); nm.className='fret-number'; nm.innerText=f; fr.appendChild(nm);
                    board.appendChild(fr);
                    // Èü≥
                    for(let s=0; s<6; s++){
                        let noteNum = openStrings[s]+f;
                        let noteIdx = noteNum%12;
                        let interval = (noteIdx - c.rootNote + 12)%12;
                        let color = c.rules[interval];
                        if(color){
                            let mk=document.createElement('div'); mk.className=`note-marker color-${color}`;
                            mk.style.left=(f*7.6 - 3.8)+'%'; mk.style.top=(s*35+25)+'px';
                            mk.innerText = (mode==='note') ? noteNames[noteIdx] : degreeNames[interval];
                            board.appendChild(mk);
                        }
                    }
                } else board.appendChild(fr);
            }
        }

        function togglePlay() {
            const btn = document.getElementById('playBtn');
            if(isPlaying) {
                clearTimeout(timerId); isPlaying=false;
                btn.innerText="‚ñ∂ START SESSION"; btn.classList.remove('active');
            } else {
                if(playList.length===0){ alert("„Ç≥„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"); return; }
                isPlaying=true; initAudio();
                btn.innerText="‚ñ† STOP"; btn.classList.add('active');
                currentIndex=0; beatIndex=0;
                step();
            }
        }

        function step() {
            if(!isPlaying) return;
            const bpm = document.getElementById('bpmSlider').value;
            const secPerBeat = 60/bpm;
            
            if(beatIndex===0) {
                drawFretboard();
                const c = playList[currentIndex];
                // ÂíåÈü≥ÂÜçÁîü
                let rootP = 48 + c.rootNote; if(rootP>60) rootP-=12;
                c.voicing.forEach(v => playTone(rootP+v, secPerBeat*4));
                currentIndex = (currentIndex+1)%playList.length;
            }
            playClick(beatIndex===0);
            beatIndex = (beatIndex+1)%4;
            timerId = setTimeout(step, secPerBeat*1000);
        }

        function updateBpm(v) { document.getElementById('bpmDisplay').innerText = `BPM: ${v}`; }
        function redraw() { drawFretboard(); }
        
        // ÂàùÊúüÂåñ
        updateStorageList();
        setupRecording(); // „Éû„Ç§„ÇØÊ∫ñÂÇôÔºàË®±ÂèØ„ÇíÊ±Ç„ÇÅ„ÇãÔºâ

    </script>
</body>
</html>